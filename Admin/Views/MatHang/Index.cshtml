@model PaginatedList<MatHang>

@{
    ViewData["Title"] = "Danh sách mặt hàng";
}

<h1>Mặt Hàng</h1>

<form asp-action="Index" method="get" class="row g-3 mb-4">
    <div class="col-md-4">
        <input type="text" name="searchName" value="@ViewBag.SearchModel?.SearchName" class="form-control" placeholder="Tìm tên sản phẩm...">
    </div>

    <div class="col-md-2">
        <select name="maLoai" class="form-control">
            <option value="">-- Chọn loại hàng --</option>
            @foreach (var item in ViewBag.LoaiHangs)
            {
                <option value="@item.MaLoaiHang" selected="@(item.MaLoaiHang == ViewBag.SearchModel?.MaLoai)">
                    @item.TenLoaiHang
                </option>
            }
        </select>
    </div>

    <div class="col-md-1">
        <input type="text" name="giaMin" value="@(ViewBag.SearchModel?.GiaMin != null ? ViewBag.SearchModel.GiaMin.ToString("N0") : "")" class="form-control currency-input" placeholder="Giá từ...">
    </div>

    <div class="col-md-1">
        <input type="text" name="giaMax" value="@(ViewBag.SearchModel?.GiaMax != null ? ViewBag.SearchModel.GiaMax.ToString("N0") : "")" class="form-control currency-input" placeholder="đến...">
    </div>

    <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Tìm kiếm</button>
    </div>

    <div class="col-md-2">
        <a asp-action="Create" class="btn btn-success w-100">
            <i class="bi bi-plus-circle"></i> Tạo mới
        </a>
    </div>

</form>

<hr />

<div id="product-container">
    <partial name="List" model="Model" />
</div>

@section Scripts {
    <script>
        // Định nghĩa hàm loadPage ở phạm vi toàn cục (Global Scope)
        window.loadPage = function(page) {

            // Hàm phụ định dạng số (giữ nguyên logic của bạn)
            const getRawNumber = (selector) => {
                let val = $(selector).val() || "";
                return val.replace(/\./g, "");
            };

            // Lấy dữ liệu từ form
            let data = {
                page: page,
                searchName: $('input[name="searchName"]').val() || null,
                maLoai: $('select[name="maLoai"]').val() || null,
                giaMin: getRawNumber('input[name="giaMin"]') || null,
                giaMax: getRawNumber('input[name="giaMax"]') || null
            };

            // Gọi AJAX
            $.ajax({
                url: '@Url.Action("Index", "MatHang")',
                type: 'GET',
                data: data,
                success: function (result) {
                    $('#product-container').html(result);
                    // Cuộn lên đầu bảng sau khi tải xong
                    $('html, body').animate({ scrollTop: $("#product-container").offset().top - 100 }, 200);
                },
                error: function(xhr, status, error) {
                    console.error(error); // Ghi lỗi ra console để dễ debug
                    alert("Lỗi khi tải dữ liệu! Vui lòng thử lại.");
                }
            });
        }
        // Hàm xác nhận xóa mặt hàng
        window.confirmDelete = function(id, name) {
            if (confirm(`Bạn có chắc chắn muốn xóa mặt hàng "${name}" không?`)) {
                $.ajax({
                    url: '@Url.Action("Delete", "MatHang")',
                    type: 'POST',
                    data: {
                        id: id,
                        // Chống lỗi CSRF (nếu project có bật)
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            // Sau khi xóa thành công, gọi lại loadPage để cập nhật danh sách tại trang hiện tại
                            // Lấy số trang hiện tại từ ViewBag hoặc từ DOM nếu cần
                            let currentPage = parseInt($('.pagination .active .page-link').text()) || 1;
                            loadPage(currentPage);
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function () {
                        alert("Đã xảy ra lỗi khi kết nối tới máy chủ.");
                    }
                });
            }
        }

        $(document).ready(function () {

            // Chặn submit form mặc định để dùng AJAX
            $('form').submit(function (e) {
                e.preventDefault();
                loadPage(1); // Tìm kiếm luôn về trang 1
            });

            // Sự kiện định dạng tiền tệ (Code cũ của bạn)
            $(document).on('input', '.currency-input', function (e) {
                let value = $(this).val().replace(/\D/g, "");
                if (value !== "") {
                    let formattedValue = new Intl.NumberFormat('vi-VN').format(value);
                    $(this).val(formattedValue);
                } else {
                    $(this).val("");
                }
            });
        });
    </script>
}
